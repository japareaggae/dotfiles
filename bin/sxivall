#!/bin/sh
# sxivall (actually rifle_sxiv.sh)
# http://git.savannah.gnu.org/cgit/ranger.git/tree/doc/examples/rifle_sxiv.sh
#
# This script searches image files in a directory, opens them all with sxiv and
# sets the first argument to the first image displayed by sxiv.
#
# For using this script with rifle, add this to your rifle.conf:
#   mime ^image, has sxiv, X, flag f = path/to/this/script -- "$@"
#
# Note: This script is quite slow (because of POSIX limitations and portability
# concerns)

if [ $# -eq 0 ]; then
    echo "Usage: ${0##*/} PICTURES"
    exit
fi

[ "$1" == '--' ] && shift

abspath () {
    case "$1" in
        /*) printf "%s\n" "$1";;
        *)  printf "%s\n" "$PWD/$1";;
    esac
}

listfiles () {
    find -L "$(dirname "$target")" -maxdepth 1 -type f -iregex \
      '.*\(jpe?g\|bmp\|png\|gif\)$' -print0 | sort -z
}

target="$(abspath "$1")"
count="$(listfiles | grep -a -m 1 -ZznF "$target" | cut -d: -f1)"

if [ -n "$count" ]; then
    listfiles | xargs -0 sxiv -n "$count" --
else
    sxiv -- "$@" # fallback
fi
