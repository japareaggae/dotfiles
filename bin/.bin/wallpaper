#!/bin/bash
# wallpaper - change wallpapers using symlinks and xwallpaper
# Written by Renan Guilherme <japareaggae@gmail.com>
# Released under the public domain <http://unlicense.org/UNLICENSE>

LOCKSCREEN_OPTS=${LOCKSCREEN_OPTS:--blur 0x4 -colorspace Gray}
POSITION="$HOME/.wallpaper0"

_usage() {
cat << EOF
Usage: $(basename "$0") [position] (filename)
Links an image to a default location and sets it as the wallpaper using xwallpaper.

Position:
  primary     Image will be the wallpaper for the first monitor (default)
  secondary   Image will be the wallpaper for the second monitor
  lockscreen  Image will be copied to .lockscreen and processed/resized with
              ImageMagick. Options can be changed via the LOCKSCREEN_OPTS
              environment variable
              Current convert options: $LOCKSCREEN_OPTS

EOF
}

die() {
	printf "Error: $1\n" >&2
	exit 1
}

### Option parsing
while :; do
	case $1 in
		"primary")     POSITION="$HOME/.wallpaper0"; ;;
		"secondary")   POSITION="$HOME/.wallpaper1"; ;;
		"lockscreen")  POSITION="$HOME/.lockscreen.png"; ;;
		"--help"|"-h") _usage; exit ;;
		--)            shift; break ;;
		*)             break ;;
	esac
	shift
done

### Check if file exists
if [[ ! $1 ]]; then
	_usage
	exit 1
elif [[ ! -e $1 ]]; then
	die "$1 is not a valid file"
fi

### Check for realpath
if ! hash realpath 2> /dev/null
then
	die "realpath is not installed"
fi
FILE="$(realpath $1)"

### Set the image
if [[ $POSITION == "$HOME/.lockscreen.png" ]]; then
	# We can't just give i3lock a giant image, it needs to be resized
	# to fit the screen. Use xrandr to figure out our resolution, then
	# use ImageMagick to resize to it and apply our desired effects.
	( hash xrandr 2> /dev/null )  || die "xrandr is not installed"
	( hash convert 2> /dev/null ) || die "ImageMagick is not installed"

	RESOLUTION=$(xrandr | grep -w primary | awk -F'[ +]' '{print $4}' | head -n 1)
	convert "$FILE" $LOCKSCREEN_OPTS -resize $RESOLUTION^ -gravity center -extent $RESOLUTION "$POSITION"
else
	# Link the file then run xrandr-adjust, which calls xwallpaper
	ln -fs "$FILE" "$POSITION"
	$HOME/.bin/xrandr-adjust
fi

