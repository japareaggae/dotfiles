#!/bin/sh
# wallpaper - change wallpapers using symlinks and feh
# Written by Renan Guilherme <japareaggae@gmail.com>
# Released under the public domain <http://unlicense.org/UNLICENSE>

LOCKSCREEN_OPTS="-blur 0x4 -brightness-contrast -15% -monitor"

_usage() {
cat << EOF
Usage: $(basename "$0") [options] (filename)
Links an image to a default location, and sets it as the wallpaper using feh.

Options:
  primary     Image will be the wallpaper for the first monitor (default)
  secondary   Image will be the wallpaper for the second monitor

  lockscreen  Image will be copied to .lockscreen and blurred
              (requires ImageMagick)

  fill        Fill the monitor with the image (default)
  center      Center the image on the monitor
  tiled       Tile the image on the monitor
EOF
exit 1
}

# Check for realpath
if ! (type realpath > /dev/null)
then
	echo "error: realpath is not installed"
	exit 1;
fi

# --- Set destination
DESTINATION="$HOME/.wallpaper0"
DEST_SET=0
set_destination(){
	if [[ $DEST_SET != 0 ]]
	then
		echo "Error: You can't set more than one destination"
		exit 1
	else
		case $1 in
			"primary")   DESTINATION="$HOME/.wallpaper0" ;;
			"secondary") DESTINATION="$HOME/.wallpaper1" ;;
			"lockscreen")
				DESTINATION="$HOME/.lockscreen.png"
				LOCKSCREEN=1
				;;
		esac
		DEST_SET=1
	fi
}

# --- Set mode
MODE="--bg-fill"
MODE_SET=0
set_mode(){
	if [[ $MODE_SET != 0 ]]
	then
		echo "Error: You can't set more than one mode"
		exit 1
	else
		case $1 in
			"fill")   MODE="--bg-fill"   ;;
			"center") MODE="--bg-center" ;;
			"tile")   MODE="--bg-tile"   ;;
		esac
		MODE_SET=1
	fi
}

# --- Attempt to parse a file
FILE="null"
FILE_SET=0
set_file(){
	if [[ $FILE_SET != 0 ]]
	then
		echo "Error: You can't set more than one file"
		exit 1
	else
		FILE="$(realpath "$1")"
		if ! [[ -f "$FILE" ]]
		then
			echo "Error: $1 is not a valid file or option"
			echo "Run \"$(basename "$0") help\" for more information"
			exit 1
		fi
		FILE_SET=1
	fi
}

# --- Option parser loop
while [[ $1 ]]
do
case $1 in
	help)       _usage ;;

	primary)    set_destination primary ;;
	secondary)  set_destination secondary ;;
	lockscreen) set_destination lockscreen ;;

	fill)       set_mode fill ;;
	center)     set_mode center ;;
	tiled)      set_mode tile ;;

	*)          set_file "$1" ;;
esac
shift
done

# --- Attempt to create symlink
if [[ $FILE == "null" ]]
then
	echo "Error: You must specify a file to use as wallpaper"
	echo "Run \"$(basename "$0") help\" for more information"
	exit 1
else

	# --- Lockscreen
	if [[ $LOCKSCREEN ]]; then
		(hash convert 2> /dev/null) || { echo "Error: ImageMagick is not installed."; exit 1; }
		convert "$FILE" $LOCKSCREEN_OPTS "$DESTINATION"
	else
		ln -sf "$FILE" "$DESTINATION"
	fi
fi

# --- Execute feh
if [[ -f "$HOME/.wallpaper1" ]]; then
	feh "$MODE" "$HOME/.wallpaper0" "$MODE" "$HOME/.wallpaper1"
else
	feh "$MODE" "$HOME/.wallpaper0"
fi
