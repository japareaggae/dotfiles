#!/bin/sh
# wallpaper - change wallpapers using symlinks and setroot
# Written by Renan Guilherme <japareaggae@gmail.com>
# Released under the public domain <http://unlicense.org/UNLICENSE>

_usage() {
cat << EOF
Usage: $(basename "$0") [options] (filename)
Links an image to a default location, and sets it as the wallpaper using setroot.

Options:
  primary     Image will be the wallpaper for the first monitor (default)
  secondary   Image will be the wallpaper for the second monitor

  zoom        Fill the monitor with the image (default)
  center      Center the image on the monitor
  tiled       Tile the image on the monitor
EOF
exit 1
}

# Check for realpath
if ! (type realpath > /dev/null)
then
	echo "error: realpath is not installed"
	exit 1;
fi

# --- Set destination
DESTINATION="$HOME/.wallpaper0"
DEST_SET=0
set_destination(){
	if [[ $DEST_SET != 0 ]]
	then
		echo "Error: You can't set more than one destination"
		exit 1
	elif [[ $1 == "primary" ]]
	then
		DESTINATION="$HOME/.wallpaper0"
		DEST_SET=1
	elif [[ $1 == "secondary" ]]
	then
		DESTINATION="$HOME/.wallpaper1"
		DEST_SET=1
	fi
}

# --- Set mode
MODE="--zoom"
MODE_SET=0
set_mode(){
	if [[ $MODE_SET != 0 ]]
	then
		echo "Error: You can't set more than one mode"
		exit 1
	elif [[ $1 == "zoom" ]]
	then
		MODE="--zoom"
		MODE_SET=1
	elif [[ $1 == "center" ]]
	then
		MODE="--center"
		MODE_SET=1
	elif [[ $1 == "tiled" ]]
	then
		MODE="--tiled"
		MODE_SET=1
	fi
}

# --- Attempt to parse a file
FILE="null"
FILE_SET=0
set_file(){
	if [[ $FILE_SET != 0 ]]
	then
		echo "Error: You can't set more than one file"
		exit 1
	else
		FILE="$(realpath "$1")"
		if ! [[ -f "$FILE" ]]
		then
			echo "Error: $1 is not a valid file or option"
			echo "Run \"$(basename "$0") help\" for more information"
			exit 1
		fi
		FILE_SET=1
	fi
}

# --- Option parser loop
while [[ $1 ]]
do
case $1 in
	help)      _usage ;;

	primary)   set_destination primary ;;
	secondary) set_destination secondary ;;

	zoom)      set_mode zoom ;;
	center)    set_mode center ;;
	tiled)     set_mode tiled ;;

	*)         set_file "$1" ;;
esac
shift
done

# --- Attempt to create symlink
if [[ $FILE == "null" ]]
then
	echo "Error: You must specify a file to use as wallpaper"
	echo "Run \"$(basename "$0") help\" for more information"
	exit 1
else
	ln -sf "$FILE" "$DESTINATION"
fi

# --- Re-execute setroot
if [ -f "$HOME/.wallpaper1" ]; then
	setroot --store "$MODE" "$HOME/.wallpaper0" "$MODE" "$HOME/.wallpaper1"
else
	setroot --store "$MODE" "$HOME/.wallpaper0"
fi
