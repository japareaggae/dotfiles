#!/bin/bash
# brightness -- A rudimentary brightness control
# Written by Renan Guilherme <japareaggae@gmail.com>
# Licensed under the public domain <http://unlicense.org/UNLICENSE>
#
# NOTE: You need to have write permissions on the brightness
# file in order to use this script.
# This can be done with the following tmpfiles.d(5) rule:
#   f /sys/class/backlight/$DEVICE/brightness 0664 root <GROUP> - -
# where <GROUP> can be your user's main group or something else (like 'wheel')

DEVICE="radeon_bl0"
STEPSIZE=8

if ! [[ -e "/sys/class/backlight/$DEVICE" ]]
then
	cat << EOF
Error: The device $DEVICE is not present in the /sys filesystem.
Make sure the DEVICE variable in the script is correct.
EOF
	exit 1
fi

CFILE="/sys/class/backlight/${DEVICE}/brightness"
MFILE="/sys/class/backlight/${DEVICE}/max_brightness"
MAXIMUM="$(cat ${MFILE})"

check_permissions(){
	if ( touch $CFILE 2> /dev/null ); then
		return 0
	else
		echo "You don't have permission to write to $CFILE."
		return 1
	fi
}

decrease(){
	check_permissions || exit 1
	NEW=$(( $(cat $CFILE) - $STEPSIZE ))
	if (( $NEW < $STEPSIZE )); then
		NEW=$STEPSIZE
	fi
	echo $NEW > $CFILE
}

increase(){
	check_permissions || exit 1
	NEW=$(( $(cat $CFILE) + $STEPSIZE ))
	if (( $NEW > $MAXIMUM )); then
		NEW=$MAXIMUM
	fi
	echo $NEW > $CFILE
}

define(){
	check_permissions || exit 1
	if [[ $1 ]] && (( $1 <= $MAXIMUM )) && (( $1 >= 0 )); then
		echo $1 > $CFILE
		cat $CFILE
	else
		echo "error: set requires a numeric argument between 0 and $MAXIMUM"
	fi
}

usage(){
cat << EOF
Usage: $(basename "$0") (cur | inc | dec | set (0-${MAXIMUM}) | max)

Manages the screen brightness using the /sys filesystem.

The current device is $DEVICE with $MAXIMUM brightness steps.

  cur    Prints current brightness
  inc    Increase brightness by $STEPSIZE steps
  dec    Decrease brightness by $STEPSIZE steps
  set    Set brightness to any level between 0 and $MAXIMUM
  max    Set brightness to $MAXIMUM
EOF
}

case $1 in
	dec)
		decrease
		cat $CFILE
		;;
	inc)
		increase
		cat $CFILE
		;;
	set)
		define $2
		;;
	max)
		define $MAXIMUM
		;;
	cur)
		cat $CFILE
		;;
	*)
		usage
		exit 1
		;;
esac
