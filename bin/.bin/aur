#!/bin/bash
# aur - A basic AUR helper
# Written by Renan Guilherme <japareaggae@gmail.com>
# Released under the public domain <http://unlicense.org/UNLICENSE>
# Inspired by faho's fish script:
# https://github.com/faho/config/blob/master/fish/.config/fish/functions/aur.fish

BOLD="$(tput bold)"
RED="$(tput setaf 1)"
GREEN="$(tput setaf 2)"
CYAN="$(tput setaf 6)"
RESET="$(tput sgr0)"

WHERE=${AURDEST:-$HOME/Development/pkgbuilds}

_check_jshon(){
	if ! ( hash jshon 2> /dev/null )
	then
		echo "Error: jshon is required to run this script"
		exit 1
	fi
}

_usage(){
cat << EOF
Usage: aur (action) [options] (package)

Actions:
    search   - Search for the specified keyword
    info     - Shows information for specified package
    clone    - Clones the repository for a package
               Add -d to clone the package and its dependencies
    download - Download a snapshot of the package's repository
               Add -d to download the package and its dependencies
    check    - Check installed packages for AUR updates
               Add -v to show packages which have lower versions on AUR
    update   - Update PKGBUILDs for installed AUR packages
    changes  - View the latest commits for this package on the AUR

The search, check, update, clone (with -d) and download (with -d) actions
require aurutils.
The info action requires jshon.

EOF
}

_search(){
	( hash aursearch 2> /dev/null ) || { echo "Error: aursearch (from aurutils) is required for this action"; exit 1; }
	[[ $1 ]] || { echo "Usage: aur search (keyword)"; exit 1; }
	aursearch "$1"
}

# A bit ugly, but it works (most of the time)
_info(){
	_check_jshon || exit 1
	[[ $1 ]] || { echo "Usage: aur info (package)"; exit 1; }
	JSON="$(curl -s "https://aur.archlinux.org/rpc.php?v=5&type=info&arg=$1")"
	RESULTS=$(printf "$JSON" | jshon -e resultcount -u )
	if [[ $RESULTS -eq 0 ]]
	then
		echo "No results found."
		exit 1
	fi

	NAME=$(printf "$JSON" | jshon -e results -a -e Name -u)
	PKGBASE=$(printf "$JSON" | jshon -e results -a -e PackageBase -u)
	VERSION=$(printf "$JSON" | jshon -e results -a -e Version -u)
	DESCRIPTION="$(printf "$JSON" | jshon -e results -a -e Description -u)"
	MAINTAINER="$(printf "$JSON" | jshon -e results -a -e Maintainer -u)"
	URL=$(printf "$JSON" | jshon -e results -a -e URL -u)
	VOTES="$(printf "$JSON" | jshon -e results -a -e NumVotes -u)"
	POPULARITY="$(printf "$JSON" | jshon -e results -a -e Popularity -u)"
	UPDATED="$(printf "$JSON" | jshon -e results -a -e LastModified -u)"

	DEPCOUNT="$(printf "$JSON" | jshon -e results -a -e Depends -l)"
	for i in $(seq $DEPCOUNT); do
		if [[ $i == 1 ]]; then
			DEPENDENCIES="$(printf "$JSON" | jshon -e results -a -e Depends -e $(($i - 1)) -u)"
		else
			DEPENDENCIES="$DEPENDENCIES $(printf "$JSON" | jshon -e results -a -e Depends -e $(($i - 1)) -u)"
		fi
	done

	OOD="$(printf "$JSON" | jshon -e results -a -e OutOfDate -u)"
	if [[ "$OOD" == "null" ]]; then
		VERSION="${BOLD}${GREEN}${VERSION}${RESET}"
	else
		WHEN="$(date -d @$OOD)"
		VERSION="${BOLD}${RED}${VERSION} (out of date since ${WHEN})${RESET}"
	fi

	cat << EOF
${BOLD}Name            ${RESET}: ${BOLD}${NAME}${RESET}
${BOLD}Package Base    ${RESET}: ${BOLD}${PKGBASE}${RESET}
${BOLD}Version         ${RESET}: ${VERSION}
${BOLD}Description     ${RESET}: ${DESCRIPTION}
${BOLD}URL             ${RESET}: ${CYAN}${URL}${RESET}
${BOLD}Dependencies    ${RESET}: ${DEPENDENCIES}
${BOLD}Maintainer      ${RESET}: ${MAINTAINER}
${BOLD}Popularity      ${RESET}: ${POPULARITY} (${VOTES} votes)
${BOLD}Last update     ${RESET}: $(date -d @${UPDATED})
${BOLD}AUR URL         ${RESET}: ${CYAN}https://aur.archlinux.org/packages/${NAME}${RESET}
${BOLD}AUR Changelog   ${RESET}: ${CYAN}https://aur.archlinux.org/cgit/aur.git/log/?h=${PKGBASE}${RESET}
${BOLD}Clone URL       ${RESET}: ${CYAN}https://aur.archlinux.org/${PKGBASE}.git${RESET}
EOF
}

_clone(){
	if [[ $1 == "-d" ]]; then
		( hash aurchain 2> /dev/null ) || { echo "Error: aurchain (from aurutils) is required for this action"; exit 1; }
		shift
		[[ $1 ]] || { echo "Usage: aur clone (package)"; exit 1; }
		for PACKAGE in $(aurchain $1); do
			git clone https://aur.archlinux.org/$PACKAGE.git $WHERE/$PACKAGE
		done
	else
		[[ $1 ]] || { echo "Usage: aur clone (package)"; exit 1; }
		git clone https://aur.archlinux.org/$1.git $WHERE/$1
	fi
}

_download(){
	if [[ $1 == "-d" ]]; then
		( hash aurchain 2> /dev/null ) || { echo "Error: aurchain (from aurutils) is required for this action"; exit 1; }
		shift
		[[ $1 ]] || { echo "Usage: aur download (package)"; exit 1; }
		for PACKAGE in $(aurchain $1); do
			curl -o $WHERE/$PACKAGE.tar.gz https://aur.archlinux.org/cgit/aur.git/snapshot/$PACKAGE.tar.gz
			(
			cd $WHERE
			tar xvf $PACKAGE.tar.gz
			rm $PACKAGE.tar.gz
			)
		done
	else
		[[ $1 ]] || { echo "Usage: aur download (package)"; exit 1; }
		curl -o $WHERE/$1.tar.gz https://aur.archlinux.org/cgit/aur.git/snapshot/$1.tar.gz
		(
		cd $WHERE
		tar xvf $1.tar.gz
		rm $1.tar.gz
		)
	fi
}

_check(){
	( hash aurcheck 2> /dev/null ) || { echo "Error: aurcheck (from aurutils) is required for this action"; exit 1; }
	pacman -Qm | aurcheck
}

_update(){
	for PACKAGE in $(_check | awk '{print $1}')
	do
		echo "==> Updating PKGBUILD for $PACKAGE"
		cd $WHERE/$PACKAGE
		git checkout master # switch to upstream branch
		git checkout HEAD . # remove all modifications (you are using a branch for that, right?)
		git pull            # get pkgbuild changes from AUR
	done
}

_changes(){
	[[ $1 ]] && xdg-open "https://aur.archlinux.org/cgit/aur.git/log/?h=$1"
}

case $1 in
	"search") shift; _search $1 ;;
	"info")   shift; _info $1 ;;
	"clone")  shift; _clone $1 $2 ;;
	"download") shift; _download $1 $2 ;;
	"check")  shift; _check $1 ;;
	"update") shift; _update ;;
	"changes") shift; _changes $1 ;;
	*)        _usage ;;
esac

