#!/bin/sh
# pkgclean: Removes outdated packages from build directories
# Written by Renan Guilherme <japareaggae@gmail.com>
# Regex magic by Victor Diniz (https://github.com/blekwave)
# Released under the public domain <http://unlicense.org/UNLICENSE>

# Where do you store your PKGBUILDs?
DEVDIR="$HOME/Development/pkgbuilds"

_usage(){
cat << EOF
Usage: pkgclean [-d DIRECTORY] (action)

Removes outdated packages from your build directory.
The default directory is $DEVDIR

Options:
  -d DIRECTORY     Scan DIRECTORY instead of default directory.

Actions:
  view | viewpkgs     View all pacman packages.
  viewsources         View all source tarballs.
  viewall             View both pacman packages and source tarballs.
  clean | cleanpkgs   Clean all pacman packages.
  cleansources        Clean all source tarballs.
  cleanall            Clean both pacman packages and source tarballs.
EOF
exit
}

# Cleaning functions
_cleanpkgs(){
find $DEVDIR -iname '*.pkg.tar*' -delete
}

_cleansources(){
find $DEVDIR | grep -P '(?!^.+(?:\.pkg)(?:\..+)?$)(^.+\.tar(?:\..+)?$)' | xargs /bin/rm
}

# Finding functions
_findpkgs(){
find $DEVDIR -iname '*.pkg.tar*' | sed "s|$DEVDIR/||g"
}

_findsources(){
find $DEVDIR | grep -P '(?!^.+(?:\.pkg)(?:\..+)?$)(^.+\.tar(?:\..+)?$)' | sed "s|$DEVDIR/||g"
}

[[ ! $1 ]] && _usage

while [[ $1 ]]; do
	case $1 in
		-d)
			shift
			DIR="$(realpath "$1")"
			if [[ -d "$DIR" ]]; then
				DEVDIR=$1
			else
				echo "Error: Directory $DIR does not exist"
				exit 1
			fi
			;;

		cleanall)          _cleanpkgs; _cleansources ;;
		cleanpkgs | clean) _cleanpkgs ;;
		cleansources)      _cleansources ;;

		viewall)         _findpkgs; _findsources ;;
		viewpkgs | view) _findpkgs ;;
		viewsources)     _findsources ;;

		help | -h | --help) _usage ;;
		*) _usage ;;
	esac
	shift
done

