#!/bin/sh
# pkgclean: Removes outdated packages from build directories
# Written by Renan Guilherme <japareaggae@gmail.com>
# Released under the public domain <http://unlicense.org/UNLICENSE>

# Where do you store your PKGBUILDs?
DEVDIR="$HOME/Development/pkgbuilds"

_usage(){
cat << EOF
Usage: pkgclean [-d DIRECTORY] (action)

Removes outdated packages from your build directory.
The default directory is $DEVDIR

Options:
  -d DIRECTORY     Scan DIRECTORY instead of default directory.

Actions:
  view             Shows week-old packages.
  viewall          Shows all packages.
  clean            Removes week-old packages.
  purge            Removes all packages.
  help             Show this message.
EOF
exit
}

# Cleaning functions
_clean(){
find $DEVDIR -iname "*.pkg.tar*" -mtime +7 -printf "%f\n" -delete
}

_cleansources(){
find $DEVDIR -regextype posix-extended -regex '.*[^pkg][.]tar[.](gz|xz|bz2)' -printf "%f\n" -delete
}

_purge(){
find $DEVDIR -iname "*.pkg.tar*" -printf "%f\n" -delete
}

# Finding functions
_findall(){
find $DEVDIR -iname "*.pkg.tar*" -printf "%f\n"
}

_findold(){
find $DEVDIR -iname "*.pkg.tar*" -mtime +7 -printf "%f\n"
}

_findsources(){
find $DEVDIR -regextype posix-extended -regex '.*[^pkg][.]tar[.](gz|xz|bz2)' -printf "%f\n"
}

[[ ! $1 ]] && _usage

while [[ $1 ]]; do
	case $1 in
		-d)
			shift
			DIR="$(realpath "$1")"
			if [[ -d "$DIR" ]]; then
				DEVDIR=$1
			else
				echo "Error: Directory $DIR does not exist"
				exit 1
			fi
			;;
		purge) _purge ;;
		clean) _clean ;;
		cleansources) _cleansources ;;
		viewall)  _findall  ;;
		view)  _findold  ;;
		viewsources) _findsources ;;
		help | -h | --help) _usage ;;
	esac
	shift
done

