#!/bin/sh
# pkgclean: Removes outdated packages from build directories
# Written by Renan Guilherme <japareaggae@gmail.com>
# Regex magic by Victor Diniz (https://github.com/blekwave)
# Released under the public domain <http://unlicense.org/UNLICENSE>

### Where do you store your PKGBUILDs?
DEVDIR="$HOME/Development/pkgbuilds"

### Internal options
PRETEND=0
CLEANPKGS=0
CLEANSRCS=0

C_BOLD="$(tput bold)"
C_RED="$(tput setaf 1)"
C_YELLOW="$(tput setaf 3)"
C_RESET="$(tput sgr0)"

_usage(){
cat << EOF
Usage: pkgclean [-d DIRECTORY] [-p] (action)

Removes outdated packages from your build directory.
The default directory is $DEVDIR

Options:
  -d DIRECTORY    Scan DIRECTORY instead of default directory.
  -p              Do not delete files, only list them.

Actions:
  clean           Clean both pacman packages and source tarballs.
  cleanpkgs       Clean all pacman packages.
  cleansources    Clean all source tarballs.
EOF
exit
}

# Cleaning functions
_cleanpkgs(){
	echo "${C_BOLD}${C_YELLOW}==>${C_RESET}${C_BOLD} Listing built packages${C_RESET}"
	find $DEVDIR -iname '*.pkg.tar*' | sed "s|$DEVDIR/||g"
if (( ! PRETEND )); then
	echo "${C_BOLD}${C_RED}==>${C_RESET}${C_BOLD} Cleaning built packages${C_RESET}"
	find $DEVDIR -iname '*.pkg.tar*' -delete
fi
}

_cleansources(){
	echo "${C_BOLD}${C_YELLOW}==>${C_RESET}${C_BOLD} Listing source packages${C_RESET}"
	find $DEVDIR | grep -P '(?!^.+(?:\.pkg)(?:\..+)?$)(^.+\.tar(?:\..+)?$)' | sed "s|$DEVDIR/||g"
if (( ! PRETEND )); then
	echo "${C_BOLD}${C_RED}==>${C_RESET}${C_BOLD} Cleaning source packages${C_RESET}"
	find $DEVDIR | grep -P '(?!^.+(?:\.pkg)(?:\..+)?$)(^.+\.tar(?:\..+)?$)' | xargs /bin/rm
fi
}

[[ ! $1 ]] && _usage

while [[ $1 ]]; do
	case $1 in
		-d)
			shift
			DIR="$(realpath "$1")"
			if [[ -d "$DIR" ]]; then
				DEVDIR="$(realpath $1)"
			else
				echo "Error: Directory $DIR does not exist"
				exit 1
			fi
			;;
		-p)
			PRETEND=1
			;;

		clean | cleanall)  CLEANPKGS=1; CLEANSRCS=1 ;;
		cleanpkgs)         CLEANPKGS=1 ;;
		cleansources)      CLEANSRCS=1 ;;

		help | -h | --help) _usage ;;
		*) _usage ;;
	esac
	shift
done

(( ! CLEANPKGS )) && (( ! CLEANSRCS )) && _usage
(( CLEANPKGS )) && _cleanpkgs
(( CLEANSRCS )) && _cleansources
