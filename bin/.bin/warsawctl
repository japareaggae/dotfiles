#!/bin/bash
#
# OVERENGINEERING: THE SCRIPT
# Written by Renan Guilherme <japareaggae@gmail.com>
# Released into the public domain <https://unlicense.org/UNLICENSE>

BOLD=$(tput bold)
COLOR_RED=$(tput setaf 1)
COLOR_GREEN=$(tput setaf 2)
COLOR_YELLOW=$(tput setaf 3)
RESET=$(tput sgr0)

usage(){
cat << EOF
Usage: ${0##*/} (start|stop)

${0##*/} is a script to automate starting and stopping the Warsaw
banking security system. It can start both the required Warsaw
instances (one for root, and one for your current user), and also
helps close both instances after you're finished.

Warsaw only works with the Firefox browser.

EOF
}

warsaw_start(){
	echo "${BOLD}==>${RESET} Starting Warsaw system instance..."
	systemctl restart warsaw
	if [[ $? -ne 0 ]]; then
		echo "${BOLD}${COLOR_RED}==>${RESET} Failed to start Warsaw system instance."
		exit 1
	fi
	echo "${BOLD}==>${RESET} Starting Warsaw user instance..."
	/usr/bin/warsaw/core
	echo "${BOLD}${COLOR_GREEN}==>${RESET} Done. You can open your browser now."
}

warsaw_stop(){
	if systemctl --quiet is-active warsaw; then
		echo "${BOLD}==>${RESET} Stopping Warsaw system instance..."
		systemctl stop warsaw
		if [[ $? -ne 0 ]]; then
			echo "${BOLD}${COLOR_RED}==>${RESET} Failed to stop Warsaw system instance."
		fi
	else
		echo "${BOLD}==>${RESET} Warsaw system instance is not running."
	fi

	if pgrep -u $USER core > /dev/null; then
		echo "${BOLD}==>${RESET} Stopping Warsaw user instance..."
		pkill -u $USER core
	else
		echo "${BOLD}==>${RESET} Warsaw user instance is not running."
	fi

	echo "${BOLD}${COLOR_GREEN}==>${RESET} Done. You can open your browser now."
}

is_firefox_running(){
	# TODO: Apparently, you can start Warsaw after Firefox and it will work fine.
	# Test this later.
	if pgrep firefox > /dev/null; then
		echo "${BOLD}${COLOR_YELLOW}==>${RESET} Firefox is already running."
		echo "${BOLD}${COLOR_YELLOW}==>${RESET} If you run into issues, close both Firefox and Warsaw, then restart Warsaw before restarting Firefox."
	fi
}

if [[ $UID -eq 0 ]]; then
	echo "${BOLD}${COLOR_RED}==>${RESET} warsawctl must be run as your own user in order to start Warsaw's user instance."
	echo "${BOLD}${COLOR_RED}==>${RESET} If you're having trouble starting the system instance, please install a polkit agent."
	exit 1
fi

case "$1" in
	"start") is_firefox_running; warsaw_start ;;
	"stop")  warsaw_stop ;;
	*)       usage ;;
esac

